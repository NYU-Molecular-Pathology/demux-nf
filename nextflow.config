// Set some default configs
params.report_template_dir = "nextseq-report"
params.workflow_label = "Demultiplexing"
username = System.getProperty("user.name")
params.email_host = "nyumc.org"
params.email_from = "${username}@${params.email_host}"
params.email_to = "${username}@${params.email_host}"

manifest {
    author = 'Stephen Kelly'
    homePage = 'https://github.com/NYU-Molecular-Pathology/demux-nf'
    description = 'Illumina bcl2fastq demultiplexing pipeline'
    mainScript = 'main.nf'
}

report {
    // enabled = true // enable from CLI instead
    file = "nextflow-report.html"
}

trace {
    // enabled = true // enable from CLI instead
    fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes"
    file = "trace.txt"
    raw = true
}

timeline {
    // enabled = true // enable from CLI instead
    file = "timeline-report.html"
}

notification {
    // enabled = true // enable from CLI instead
    to = "${params.email_to}"
    from = "${params.email_from}"
}

params.beforeScript_str = 'printf "USER:\${USER:-none} JOB_ID:\${JOB_ID:-none} JOB_NAME:\${JOB_NAME:-none} HOSTNAME:\${HOSTNAME:-none} PWD:\$PWD\n"; TIMESTART=\$(date +%s)'
process.beforeScript = "${params.beforeScript_str}"

profiles { // locations to run the pipeline
    phoenix { // for NYULMC phoenix HPC
        process.queue = 'all.q'
        params.sequencerDir = "/ifs/data/molecpathlab/quicksilver"
        params.production_dir = "/ifs/data/molecpathlab/production/Demultiplexing"
        params.multiqc_setup_cmd = "module unload python ; unset PYTHONPATH ; unset PYTHONHOME ; source /ifs/data/molecpathlab/bin/conda3/bin/activate ; conda activate multiqc-1.5 ; export LANG=en_US.utf8 ; export LC_ALL=en_US.utf8 "
        process.$validate_samplesheet.module = "python/2.7"
        process.$bcl2fastq.module = "bcl2fastq/2.17.1"
        process.$bcl2fastq.executor = "sge"
        process.$bcl2fastq.clusterOptions = "-pe threaded 4-24 -l mem_free=32G -l mem_token=2G"
        process.$multiqc.beforeScript = "${process.beforeScript} ; ${params.multiqc_setup_cmd}"
        process.$fastqc.module = "fastqc/0.11.7"
        process.$fastqc.executor = "sge"
        process.$fastqc.clusterOptions = "-l mem_free=8G -l mem_token=8G"
        process.$demultiplexing_report.module = "pandoc/1.13.1:r/3.3.0"
    }
    bigpurple { // NYULMC Big Purple HPC cluster
        process.executor = "slurm"
        process.queue = "cpu_short" // up to 12hrs per job
        executor.queueSize = 8
        process.clusterOptions = '--ntasks-per-node=1 --export=NONE'

        params.sequencerDir = "/gpfs/data/molecpathlab/production/quicksilver" 
        params.containerDir = "/gpfs/data/molecpathlab/containers/demux-nf"

        process.module = "singularity/2.5.2"
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.runOptions = "-B ${params.sequencerDir}"
        singularity.envWhitelist = "NTHREADS"

        process {
            withName: validate_samplesheet {
                container = "${params.containerDir}/python-2.7.simg"
            }
            withName: convert_run_params {
                container = "${params.containerDir}/python-2.7.simg"
            }
            withName: bcl2fastq {
                container = "${params.containerDir}/bcl2fastq-2.17.1.simg"
                cpus = 20
                beforeScript = 'export NTHREADS=20'
            }
            withName: fastqc {
                container = "${params.containerDir}/fastqc-0.11.7.simg"
                cpus = 1
            }
            withName: multiqc {
                container = "${params.containerDir}/multiqc-1.5.simg"
            }
            withName: demultiplexing_report {
                container = "${params.containerDir}/report-r-3.4.3.simg"
            }
        }
    }
}

profiles { // pipeline run settings
    NGS580 {
        params.bcl2fastq_params = "--no-lane-splitting --ignore-missing-bcls --ignore-missing-filter --ignore-missing-positions --ignore-missing-controls --auto-set-to-zero-barcode-mismatches --find-adapters-with-sliding-window --adapter-stringency 0.9 --mask-short-adapter-reads 35 --minimum-trimmed-read-length 35"
    }

    Archer {
        params.bcl2fastq_params = "--no-lane-splitting"
    }
}
